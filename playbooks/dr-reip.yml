---
- name: Re-IP RHEL DR VMs using Red Hat system role
  hosts: linux_dr_vms
  become: true
  vars:
    network_connections:
      - name: "{{ dr_iface }}"
        type: ethernet
        interface_name: "{{ dr_iface }}"
        state: up
        ip:
          dhcp4: no
          auto6: no
          address:
            - "{{ dr_ip }}/{{ dr_prefix }}"
          gateway4: "{{ dr_gateway | default(omit) }}"
          dns: "{{ dr_dns | default([]) }}"
  roles:
    - redhat.rhel_system_roles.network

- name: Re-IP Windows DR VMs using PowerShell via Ansible
  hosts: windows_dr_vms
  gather_facts: false
  vars:
    ps_interface_alias: "{{ dr_interface_alias }}"
    ps_ip: "{{ dr_ip }}"
    ps_prefix: "{{ dr_prefix }}"
    ps_gateway: "{{ dr_gateway }}"
    ps_dns: "{{ dr_dns | default([]) }}"
  tasks:
    - name: Show current IP configuration (debug only)
      ansible.windows.win_shell: |
        Get-NetIPConfiguration -InterfaceAlias '{{ ps_interface_alias }}' | Format-List
      register: before_ip
      changed_when: false

    - name: Remove existing IPv4 addresses on the interface (except link-local)
      ansible.windows.win_shell: |
        Get-NetIPAddress -InterfaceAlias '{{ ps_interface_alias }}' -AddressFamily IPv4 |
          Where-Object { -not ($_.IPAddress -like '169.254.*') } |
          Remove-NetIPAddress -Confirm:$false

    - name: Configure new IPv4 + gateway
      ansible.windows.win_shell: |
        New-NetIPAddress `
          -InterfaceAlias '{{ ps_interface_alias }}' `
          -IPAddress '{{ ps_ip }}' `
          -PrefixLength {{ ps_prefix }} `
          -DefaultGateway '{{ ps_gateway }}'

    - name: Configure DNS servers if provided
      when: ps_dns | length > 0
      ansible.windows.win_shell: |
        Set-DnsClientServerAddress `
          -InterfaceAlias '{{ ps_interface_alias }}' `
          -ServerAddresses {{ ps_dns | to_json }}
